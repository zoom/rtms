name: rtms

# Base configuration for all services
x-base: &base
  build:
    context: .
  platform: linux/amd64
  cap_add:
    - SYS_PTRACE
  security_opt:
    - seccomp:unconfined
  volumes:
    - .:/tmp/rtms
    - ./logs:/tmp/rtms/logs
    - ./test-results:/tmp/rtms/test-results
  working_dir: /tmp/rtms
  develop:
    watch:
      - action: rebuild
        path: ./
        ignore:
          - dist
          - logs
          - node_modules
          - test-results
        target: /tmp/rtms

services:
  # =============================================================================
  # Build Service - Universal build environment with Task installed
  # =============================================================================
  build:
    <<: *base
    build:
      context: .
      args:
        TARGET: all  # Install all dependencies
    # Default command: run bash (for interactive use)
    # Override with: docker compose run build task <command>
    command: /bin/bash

  # =============================================================================
  # Test Services - Pre-configured for running tests
  # =============================================================================
  test-js:
    <<: *base
    build:
      context: .
      args:
        TARGET: js
    ports:
      - "8080:8080"
    command: sh -c "task build:js && task manual:js"

  test-py:
    <<: *base
    build:
      context: .
      args:
        TARGET: py
    ports:
      - "8080:8080"
    command: sh -c "task build:py && echo 'Python tests not yet implemented'"

  # =============================================================================
  # Docs Service - Documentation generation
  # =============================================================================
  docs:
    <<: *base
    build:
      context: .
      args:
        TARGET: all
    command: sh -c "task docs:all"
    volumes:
      - .:/tmp/rtms
      - ./docs:/tmp/rtms/docs
