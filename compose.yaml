name: rtms

x-base: &base
  build:
    context: .
    args:
      TARGET: all  # Default to all dependencies
  platform: linux/amd64
  cap_add:
    - SYS_PTRACE
  security_opt:
    - seccomp:unconfined
  volumes:
    - .:/tmp/rtms
    - ./logs:/tmp/rtms/logs
  develop:
    watch:
      - action: rebuild
        path: ./
        ignore: 
          - dist
          - logs
          - node_modules
        target: /tmp/rtms

services:
  js: &js
    <<: *base
    build:
      args:
        TARGET: js
    command: npm run prebuild
  test-js:
    <<: *base
    build:
      args:
        TARGET: js
    depends_on:
      js:
        condition: service_completed_successfully
    command: npm run test:js-manual
    ports:
      - 8080:8080
  py: &py
    <<: *base
    build:
      args:
        TARGET: py
    command: npm run build:py
  test-py:
    <<: *base
    build:
      args:
        TARGET: py
    depends_on:
      py:
        condition: service_completed_successfully
    command: npm run test:py-manual
    ports:
      - 8080:8081
  go: &go
    <<: *base
    build:
      args:
        TARGET: go
  test-go:
    <<: *base
    build:
      args:
        TARGET: go
    depends_on:
      go:
        condition: service_completed_successfully
    command: npm run test:go-manual
    ports:
      - 8080:8082